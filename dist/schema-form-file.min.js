/**
 * angular-schema-form-nwp-file-upload - Upload file type for Angular Schema Form
 * @version v0.1.5
 * @link https://github.com/saburab/angular-schema-form-nwp-file-upload
 * @license MIT
 */
"use strict";angular.module("schemaForm").config(["schemaFormProvider","schemaFormDecoratorsProvider","sfPathProvider","sfBuilderProvider",function(e,r,i,l){function o(e,r,i){e.validationMessage=e.validationMessage||{};for(var l in i)r[l]&&!e.validationMessage[l]&&(e.validationMessage[l]=i[l])}function a(){function r(r,l,a){if("object"===l.type&&"singlefile"===l.format){var n=e.stdFormObj(r,l,a);return n.key=a.path,n.type="nwpFileUpload",a.lookup[i.stringify(a.path)]=n,o(n,l,t),n}}function l(r,l,a){if("array"===l.type&&"multifile"===l.format){var t=e.stdFormObj(r,l,a);return t.key=a.path,t.type="nwpFileUpload",a.lookup[i.stringify(a.path)]=t,o(t,l,n),t}}e.defaults.array.unshift(r),e.defaults.array.unshift(l)}var t={maxSize:"This file is too large ({{file.size / 1000000 | number:1}}MB). Maximum size allowed is {{schema.maxSize}}",mimeType:"Wrong file type. Allowed types are {{schema.mimeType}}"},n={maxSize:t.maxSize,mimeType:t.mimeType,minItems:"You have to upload at least {{schema.minItems}} file(s)",maxItems:"You can't upload more than {{schema.maxItems}} file(s)."};a(),r.defineAddOn("bootstrapDecorator","nwpFileUpload","directives/decorators/bootstrap/nwp-file/schema-form-file.html",l.stdBuilders)}]),angular.module("ngSchemaFormFile",["ngFileUpload","ngMessages","pascalprecht.translate"]).controller("ngSchemaFileController",["$scope","$log","Upload","$interpolate","$translate","$timeout","$q","$http","$window",function(e,r,i,l,o,a,t,n,s){function m(r){S=r,M=e.form&&e.form.endpoint,e.isSinglefileUpload=e.form&&e.form.schema&&"singlefile"===e.form.schema.format,e.$on("schemaFormValidate",e.validateField),e.$on("schemaFormFileUploadSubmit",e.submit),a(w)}function d(){S.$setViewValue(),S.$commitViewValue()}function p(){var r=e.uploadForm.file;r.$setViewValue(),r.$commitViewValue(),delete e.picFile}function c(r){for(var i="",l=e.$$prevSibling;l&&l.form&&l.form.key&&l.form.key.join(".").startsWith(e.form.key.join("."));)l.form.required=r,l.$broadcast("schemaFormValidate"),i+="model."+l.form.key.join(".")+"&&",l=l.$$prevSibling;i.length>0&&(i=i.substring(0,i.length-2)),e.fieldToWatch=i}function f(){var e=S.$modelValue;if(e){var r=e.idPropertyName;if(r)return S.$modelValue[r]}}function u(){y(),d(),p(),e.removeWatchForRequireMetadata&&(e.removeWatchForRequireMetadata(),delete e.removeWatchForRequireMetadata,e.$broadcast("schemaForm.error."+e.form.key.join("."),"requireMetadata",!0),c(!1))}function g(e){v(angular.merge({},e,{progress:100})),F(S.$modelValue)}function h(e){var r;404===e.status?(r='File "{{ file.name }}" no longer exists on server, please upload again.',v({progress:0,status:"none"})):410===e.status?(r='File "{{ file.name }}" is expired, please upload again.',v({progress:0,status:"expired"})):(r='Failed to get file "{{ file.name }}" from server: '+e.statusText,v({progress:0,status:"sync_error"})),$(r)}function v(e){S.$modelValue?S.$setViewValue(angular.merge(S.$modelValue,e)):S.$setViewValue(e),S.$commitViewValue()}function F(r){e.picFile={result:r,name:r.name,progress:angular.isNumber(r.progress)?r.progress:0,size:angular.isNumber(r.size)?r.size:void 0,type:r.type,status:r.status}}function b(r){r&&!r.$error&&M&&(y(),r.upload=i.upload({url:M,file:r,data:{metadata:S.$modelValue}}),r.upload.then(function(i){var l=i.data;a(function(){r.result=l}),v(l);var o=e.form&&e.form.saveFormAfterUploaded;o&&e.$emit("rdsSchemaFormCtrl.save",{source:"ngSchemaFile",file:r,form:e.form})},function(e){e.status>0&&($("File Upload Failed!"),delete r.progress)}),r.upload.progress(function(i){e.errorMsg?delete r.progress:r.progress=Math.min(100,parseInt(100*i.loaded/i.total))}))}function $(r){var i=l(r)({file:S.$modelValue});e.errorMsg=i}function y(){delete e.errorMsg}function w(){if(!e.isSinglefileUpload)return void r.warn("ngSchemaFileController#syncFileStatus - only support single file at the moment");var i=f();return i?void n({method:"GET",url:M+"/"+i}).then(function(e){g(e.data)})["catch"](function(e){h(e)}):void r.info("ngSchemaFileController#syncFileStatus - skipped due to id is: "+i)}var M,x=this,S=null;x.init=m,e.selectFile=function(i){if(i){if(e.picFile=i,e.$$prevSibling&&e.$$prevSibling.form&&e.$$prevSibling.form.key.join(".").startsWith(e.form.key.join("."))){c(!0);var l="evalExpr('"+e.fieldToWatch+"',{ model: model, 'arrayIndex': 0, 'modelValue': ''})";e.removeWatchForRequireMetadata=e.$watch(l,function(r){r?e.$broadcast("schemaForm.error."+e.getModelPath().join("."),"requireMetadata",null,!0):e.$broadcast("schemaForm.error."+e.getModelPath().join("."),"requireMetadata",null,!1)})}e.form&&e.form.autoUploadOnSelect===!0&&a(function(){S.$valid?e.uploadFile(i):r.debug("ngSchemaFileController#selectFile - ngModel is invlid, skip auto upload")})}},e.selectFiles=function(r){e.picFiles=r},e.uploadFile=function(e){e&&b(e)},e.uploadFiles=function(e){e.length&&angular.forEach(e,function(e){b(e)})},e.validateField=function(){e.uploadForm.file&&e.uploadForm.file.$valid&&e.picFile&&!e.picFile.$error||e.uploadForm.files&&e.uploadForm.files.$valid&&e.picFiles&&!e.picFiles.$error},e.submit=function(){e.uploadForm.file&&e.uploadForm.file.$valid&&e.picFile&&!e.picFile.$error?e.uploadFile(e.picFile):e.uploadForm.files&&e.uploadForm.files.$valid&&e.picFiles&&!e.picFiles.$error&&e.uploadFiles(e.picFiles)},e.removeFile=function(){if(!e.isSinglefileUpload)return void r.warn("ngSchemaFileController#removeFile - only support single file at the moment");var i=f();i?n({method:"DELETE",url:M+"/"+i}).then(function(e){var r=e.data;r?u():s.alert("Failed to remove file.")},function(e){s.alert("An error happened when deleting the file: "+e.statusText),r.error(e)}):(r.info("ngSchemaFileController#removeFile - remove the file without remote call due to id is: "+i),u())},e.isValidFile=function(){var r=e.picFile;return!!r&&("none"!==r.status&&"expired"!==r.status)},e.interpValidationMessage=function(r){if(r){var i,a=r.$error,t=e.form,n=t.validationMessage;if(angular.isString(n)?i=n:angular.isObject(n)&&(i=n[a]),!i)return a;var s={error:a,file:r,form:t,schema:t.schema,title:t.title||t.schema&&t.schema.title},m=l(i)(s);return o.instant(m)}}}]).directive("ngSchemaFile",function(){return{restrict:"A",$scope:!0,controller:"ngSchemaFileController",controllerAs:"fileUploadCtrl",require:"ngModel",link:function(e,r,i,l){e.fileUploadCtrl.init(l)}}}),angular.module("schemaForm").run(["$templateCache",function(e){e.put("directives/decorators/bootstrap/nwp-file/schema-form-file.html",'<ng-form class="file-upload mb-lg" ng-schema-file schema-validate="form" sf-field-model="replaceAll" ng-model="$$value$$" name="uploadForm">\r\n  <label ng-show="form.title && form.notitle !== true" class="control-label" for="fileInputButton" ng-class="{\'sr-only\': !showTitle(), \'text-danger\': uploadForm.$error.required && !uploadForm.$pristine}">\r\n    {{::form.title}}<i ng-show="form.required">&nbsp;*</i>\r\n  </label>\r\n\r\n  <div ng-show="picFile" class="well well-sm bg-white mb" ng-class="{\'has-error border-danger\': (uploadForm.$error.required && !uploadForm.$pristine) || (hasError() && errorMessage(schemaError()))}">\r\n    <div ng-include="\'directives/decorators/bootstrap/nwp-file/schema-form-file.template.progress.html\'" class="mb"></div>\r\n    <div ng-include="\'directives/decorators/bootstrap/nwp-file/schema-form-file.template.errors.html\'" class="mb"></div>\r\n    <span class="help-block" sf-message="form.description"></span>\r\n  </div>\r\n\r\n  <ul ng-show="picFiles && picFiles.length" class="list-group">\r\n    <li class="list-group-item" ng-repeat="picFile in picFiles">\r\n      <div ng-include="\'directives/decorators/bootstrap/nwp-file/schema-form-file.template.progress.html\'"></div>\r\n      <div ng-include="\'directives/decorators/bootstrap/nwp-file/schema-form-file.template.errors.html\'" class="mb"></div>\r\n    </li>\r\n  </ul>\r\n\r\n  <div ng-show="(isSinglefileUpload && !picFile) || (!isSinglefileUpload && (!picFiles || !picFiles.length))" class="well well-sm bg-white mb" ng-class="{\'has-error border-danger\': (uploadForm.$error.required && !uploadForm.$pristine) || (hasError() && errorMessage(schemaError()))}">\r\n    <small class="text-muted" ng-show="form.description" ng-bind-html="form.description"></small>\r\n    <div ng-if="isSinglefileUpload" ng-include="\'directives/decorators/bootstrap/nwp-file/schema-form-file.template.single.html\'"></div>\r\n    <div ng-if="!isSinglefileUpload" ng-include="\'directives/decorators/bootstrap/nwp-file/schema-form-file.template.multiple.html\'"></div>\r\n    <!--<div class="help-block mb0" ng-show="uploadForm.$error.required && !uploadForm.$pristine">{{ \'modules.attribute.fields.required.caption\' | translate }}</div>-->\r\n    <span ng-if="errorMsg" class="text-danger">{{ errorMsg }}</span>\r\n    <span class="help-block" sf-message="form.description"></span>\r\n  </div>\r\n</ng-form>\r\n'),e.put("directives/decorators/bootstrap/nwp-file/schema-form-file.template.errors.html",'<div ng-messages="uploadForm.$error" ng-messages-multiple="">\r\n  <div class="text-danger errorMsg" ng-message="maxSize">{{ interpValidationMessage(picFile) }}</div>\r\n  <div class="text-danger errorMsg" ng-message="mimeType">{{ interpValidationMessage(picFile) }}</div>\r\n  <div class="text-danger errorMsg" ng-message="maxItems">{{ interpValidationMessage(picFile) }}</div>\r\n  <div class="text-danger errorMsg" ng-message="minItems">{{ interpValidationMessage(picFile) }}</div>\r\n  <div class="text-danger errorMsg" ng-show="errorMsg">{{ errorMsg }}</div>\r\n</div>'),e.put("directives/decorators/bootstrap/nwp-file/schema-form-file.template.multiple.html",'<div ngf-drop="selectFiles(picFiles)" ngf-select="selectFiles(picFiles)" type="file" ngf-multiple="true"\r\n    ng-model="picFiles" name="files"\r\n    ng-attr-ngf-mimeType="{{::form.schema.mimeType ? form.schema.mimeType : undefined }}"\r\n    ng-attr-ngf-max-size="{{::form.schema.maxSize ? form.schema.maxSize : undefined }}"\r\n    ng-required="form.required"\r\n    accept="{{::form.schema.mimeType}}"\r\n    ng-model-options="form.ngModelOptions" ngf-drag-over-class="dragover" class="drop-box dragAndDropDescription">\r\n  <p class="text-center">{{ \'modules.upload.descriptionMultifile\' | translate }}</p>\r\n</div>\r\n<div ngf-no-file-drop>{{ \'modules.upload.dndNotSupported\' | translate}}</div>\r\n\r\n<button ngf-select="selectFiles(picFiles)" type="file" ngf-multiple="true" multiple ng-model="picFiles" name="files"\r\n       ng-attr-ngf-mimeType="{{::form.schema.mimeType ? form.schema.mimeType : undefined }}"\r\n       ng-attr-ngf-max-size="{{::form.schema.maxSize ? form.schema.maxSize : undefined }}"\r\n       ng-required="form.required"\r\n       accept="{{::form.schema.mimeType}}"\r\n       ng-model-options="form.ngModelOptions" id="fileInputButton"\r\n       class="btn btn-default btn-block {{::form.htmlClass}} mt-lg mb rds-fileupload-selectfile-btn">\r\n  <fa fw="fw" name="upload" class="mr-sm"></fa>\r\n  {{:: \'buttons.add\' | translate }}\r\n</button>\r\n'),e.put("directives/decorators/bootstrap/nwp-file/schema-form-file.template.progress.html",'<div class="row mb">\r\n  <div class="col-sm-4 mb-sm">\r\n     <label title="{{ \'modules.upload.field.preview\' | translate }}" class="text-info">{{\r\n        \'modules.upload.field.preview\' | translate }}</label>\r\n     <img ngf-src="picFile" class="img-thumbnail img-responsive">\r\n     <div class="img-placeholder"\r\n          ng-class="{\'show\': picFile.$invalid && !picFile.blobUrl, \'hide\': !picFile || picFile.blobUrl}">No preview available\r\n     </div>\r\n  </div>\r\n  <div class="col-sm-4 mb-sm">\r\n     <label title="{{ \'modules.upload.field.filename\' | translate }}" class="text-info">{{\r\n        \'modules.upload.field.filename\' | translate }}</label>\r\n     <div class="filename" title="{{ picFile.name }}">{{ picFile.name }}</div>\r\n  </div>\r\n  <div class="col-sm-4 mb-sm" ng-if="!form.readonly">\r\n     <label title="{{ \'modules.upload.field.progress\' | translate }}" class="text-info">{{\r\n        \'modules.upload.field.progress\' | translate }}</label>\r\n     <div class="progress">\r\n        <div class="progress-bar progress-bar-striped" role="progressbar"\r\n             ng-class="{\'progress-bar-success\': picFile.progress == 100}"\r\n             ng-style="{width: picFile.progress + \'%\'}">\r\n           {{ picFile.progress }} %\r\n        </div>\r\n     </div>\r\n     <button class="btn btn-default btn-sm rds-fileupload-upload-btn" type="button" ng-click="uploadFile(picFile)"\r\n             ng-disabled="ngModel.$error.requireMetadata||!picFile || picFile.result || picFile.$error">{{ !picFile.result ?  "buttons.upload" : "buttons.uploaded" | translate }}\r\n     </button>\r\n     <button class="btn btn-default btn-sm rds-fileupload-remove-btn" type="button" ng-click="removeFile(picFile)"\r\n             ng-disabled="!picFile">{{ "buttons.remove" | translate }}\r\n     </button>\r\n  </div>\r\n</div>\r\n'),e.put("directives/decorators/bootstrap/nwp-file/schema-form-file.template.single.html",'<div ngf-drop="selectFile(picFile)" ngf-select="selectFile(picFile)" type="file" ngf-multiple="false"\r\n    ng-model="picFile" name="file"\r\n    ng-attr-ngf-mimeType="{{::form.schema.mimeType ? form.schema.mimeType : undefined }}"\r\n    ng-attr-ngf-max-size="{{::form.schema.maxSize ? form.schema.maxSize : undefined }}"\r\n    ng-required="form.required"\r\n    accept="{{::form.schema.mimeType}}"\r\n    ng-model-options="form.ngModelOptions" ngf-drag-over-class="dragover" class="drop-box dragAndDropDescription">\r\n  <p class="text-center">{{ \'modules.upload.descriptionSinglefile\' | translate }}</p>\r\n</div>\r\n<div ngf-no-file-drop>{{ \'modules.upload.dndNotSupported\' | translate}}</div>\r\n\r\n<button ngf-select="selectFile(picFile)" type="file" ngf-multiple="false" ng-model="picFile" name="file"\r\n       ng-attr-ngf-mimeType="{{::form.schema.mimeType ? form.schema.mimeType : undefined }}"\r\n       ng-attr-ngf-max-size="{{::form.schema.maxSize ? form.schema.maxSize : undefined }}"\r\n       ng-required="form.required"\r\n       accept="{{::form.schema.mimeType}}"\r\n       ng-model-options="form.ngModelOptions" id="fileInputButton"\r\n       class="btn btn-default btn-block {{::form.htmlClass}} mt-lg mb rds-fileupload-selectfile-btn">\r\n  <fa fw="fw" name="upload" class="mr-sm"></fa>\r\n  {{:: \'buttons.add\' | translate }}\r\n</button>\r\n')}]);